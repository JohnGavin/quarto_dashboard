---
title: "Untitled"
format: html
---


```{r}
# https://eodhd.com/cp/dashboard
Sys.setenv("eodhd.com"="6689a9ba4e32b4.43072976")
pacman::p_load(purrr, dplyr, glue, httr, jsonlite)

# FIXME: demo works but eodhd_com_token fails
eodhd_com_token <- Sys.getenv("eodhd.com")
eodhd_com_token <- "demo" 

eodhd_get <- function(url) GET(url)
str(eodhd_get)
contentt <- function(response){
    got_response <- http_type(response) == "application/json"
    ifelse(got_response,
        response |> 
        content("text", encoding = "UTF-8") |> 
        fromJSON(flatten = TRUE),
        {   cat("Error while receiving data\n")
            NA
        }
    )
}


# https://eodhd.com/financial-apis/stock-etfs-fundamental-data-feeds/?preview=true#Historical_Constituents_for_Indices
# 20.000 US Funds / 10,000 ETFs from different exchanges and countries
# Index Constituents (or Index Components) data for all major indices all around the world.

# demo API Key works only for AAPL.US and VTI.US
ticker_demo <- c(
    "AAPL.US", "TSLA.US", "VTI.US", "AMZN.US", "MSFT.US", "EUR-USD")[1]
(ticker_url <- tickers_demo |> paste0(collapse = "|"))
# Symbols from major US exchanges (around 11000 tickers in total from NYSE, NASDAQ, and ARCA) supported for 20 years both yearly and quarterly. For minor companies, we have data for the last 6 years and the previous 20 quarters. 

# fundamental data feeds only in JSON format
(url <- glue('https://eodhd.com/api/fundamentals/{ticker_url}?api_token={eodhd_com_token}&fmt=json'))
(resp <- url |> eodhd_get())
resp |> str(max.level = 1, list.len = 12) 
http_type(resp) 
resp |> content("text", encoding = "UTF-8") |> 
        fromJSON(flatten = TRUE)

# Sample reply
# https://eodhistoricaldata.com/api/fundamentals/AAPL.US?api_token=demo&_gl=1*57zryw*_gcl_au*MTE5MjEwMDQ2Mi4xNzIwMjk3ODA5*FPAU*MTE5MjEwMDQ2Mi4xNzIwMjk3ODA5*_ga*NjY2ODEwMDIuMTcyMDI5NzUxNA..*_ga_NRYML8NKGH*MTcyMDI5NzUxMy4xLjEuMTcyMDMwMDQ1NC4wLjAuMTk0MzQ3OTA3Nw..*_fplc*dVhJNSUyQmpaUlFiTTV3bkQlMkZBMUtISkpVUWZwNE9STHBCRllxNXpFbDhyQXRPSEs5bmklMkJ5RUlMSHZkRFFhRWQlMkJZUUk3V1I1SW0xRmdMSncwOFlmSW9YSG1DaXh4N3dUVFlDSm8yb1FUeVBvb3BPQkclMkJXZ2ZJVEpNQXFCMSUyQlB3JTNEJTNE

cont <- resp |> contentt()
# FIXME: what happened to the 11 top level list items
# General Highlights Earnings Financials
# For example, if you want to get only the ‘General’ block, then you can use the following URL:
# https://eodhd.com/api/fundamentals/AAPL.US?filter=General::Code&api_token=demo&fmt=json
# https://eodhd.com/api/fundamentals/AAPL.US?filter=Financials::Balance_Sheet::yearly&api_token=demo&fmt=json
# https://eodhd.com/api/fundamentals/AAPL.US?filter=General::Code,General,Earnings&api_token=demo&fmt=json

cont |> str(max.level = 1, list.len = 37) 
cont %>% `[[`(1) |> names()
cont |> pluck('General') |> str(max.level = 1, list.len = 37) 
# IsDelisted – where the ticker had been delisted or not.
# DelistedDate – the date of ticker delisting.
cont |> fromJSON(flatten = TRUE) |> pluck('General') |> pluck('Listings')

# TODO: use AI to scrape
# $`0`$Code [1] "0R2V" $`0`$Exchange [1] "LSE"
# https://markets.ft.com/data/equities/tearsheet/summary?s=0R2V:LSE
# AAPL.MX for Mexican Stock Exchange. Or AAPL.US for NASDAQ

# symbols instead of the entire exchange, just add the parameter &symbols=
GET("https://eodhd.com/api/bulk-fundamentals/NASDAQ?&symbols=AAPL.US,MSFT.US&api_token=demo&fmt=json") |>
    content()

# FREE API offers access to most of stocks, forex pairs, ETFs and covers EOD Historical (limited 1 year history only) data, Live data, Splits & Dividents and more

# constituents NOT FREE
# https://eodhd.com/pricing
# https://eodhd.com/api/fundamentals/GSPC.INDX?api_token={YOUR_API_TOKEN}&fmt=json
# “demo” key default but we reccomend to sign up for free to get an API key from free plan. With it, more data will be available.

# Historical Constituents for Indices. NOT FREE API
# from 2010 (10+ years) and includes more than 500 tickers: active, non-active (previously included in S&P 500), and delisted.
# https://eodhd.com/api/bulk-fundamentals/NASDAQ?api_token={YOUR_API_TOKEN}&fmt=json
GET("https://eodhd.com/api/bulk-fundamentals/NASDAQ?api_token=demo&fmt=json") |>
    content()
     http_type()
        #content("text", encoding = "UTF-8") |> 
        #fromJSON(flatten = TRUE)

# https://eodhd.com/financial-apis/stock-etfs-fundamental-data-feeds/?preview=true#Historical_Constituents_for_Indices:~:text=full%20list%20of%20supported%20exchanges
# fundamentals data for the NASDAQ / default data format is CSV.
# get 200 symbols starting with symbol number 1000: &limit=200 and offset=1000.
# https://eodhd.com/api/bulk-fundamentals/NASDAQ?offset=500&limit=100&api_token=demo&fmt=json

# FREE API does not offer constituents
(url <- glue('https://eodhd.com/api/exchanges-list/?api_token={eodhd_com_token}&fmt=json'))
url <- 'https://eodhd.com/api/exchanges-list/?api_token=demo&fmt=json'

url <- 'https://eodhd.com/api/search/apple?api_token=demo&fmt=json'
(resp <- url |> eodhd_get())
cont <- contentt(resp)
```
